name: Management Pack CI

on:
  push:
    branches-ignore:
      - main
      - codex/**
    paths:
      - "Management Pack/**"
      - ".github/workflows/management-pack-ci.yml"

  pull_request:
    branches:
      - main
    paths:
      - "Management Pack/**"
      - ".github/workflows/management-pack-ci.yml"
  workflow_dispatch:

jobs:
  sdk-validation:
    runs-on: ${{ vars.mp_ci_runner || 'ubuntu-latest' }}
    env:
      VENV_DIR: /tmp/vcf-mp-sdk-venv
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Create isolated virtual environment
        run: python -m venv "$VENV_DIR"

      - name: Install SDK tooling in venv
        run: |
          source "$VENV_DIR/bin/activate"
          python -m pip install --upgrade pip
          pip install -r "Management Pack/requirements.txt"

      - name: Validate adapter definition with SDK mp-test
        run: |
          source "$VENV_DIR/bin/activate"
          mp-test -p "Management Pack" adapter_definition

      - name: Cleanup virtual environment
        if: always()
        run: rm -rf "$VENV_DIR"

  sdk-integration-smoke-test:
    runs-on: ${{ vars.mp_ci_runner || 'ubuntu-latest' }}
    needs: sdk-validation
    env:
      VENV_DIR: /tmp/vcf-mp-sdk-venv
      VCF_OPS_HOST: ${{ secrets.VCF_OPS_HOST }}
      VCF_OPS_USERNAME: ${{ secrets.VCF_OPS_USERNAME }}
      VCF_OPS_PASSWORD: ${{ secrets.VCF_OPS_PASSWORD }}
      VCENTER_HOST: ${{ secrets.VCENTER_HOST }}
      VCENTER_USERNAME: ${{ secrets.VCENTER_USERNAME }}
      VCENTER_PASSWORD: ${{ secrets.VCENTER_PASSWORD }}
      VCENTER_PORT: "443"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Apply optional vCenter port variable
        run: |
          if [ -n "${{ vars.VCENTER_PORT }}" ]; then
            echo "VCENTER_PORT=${{ vars.VCENTER_PORT }}" >> "$GITHUB_ENV"
          fi

      - name: Check required secrets
        id: secret_check
        run: |
          missing=0
          for key in VCF_OPS_HOST VCF_OPS_USERNAME VCF_OPS_PASSWORD VCENTER_HOST VCENTER_USERNAME VCENTER_PASSWORD; do
            if [ -z "${!key}" ]; then
              echo "Missing required secret mapped to: $key"
              missing=1
            fi
          done

          if [ "$missing" -eq 1 ]; then
            echo "run_smoke=false" >> "$GITHUB_OUTPUT"
            echo "Skipping smoke tests because required secrets are not configured."
          else
            echo "run_smoke=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create isolated virtual environment
        if: steps.secret_check.outputs.run_smoke == 'true'
        run: python -m venv "$VENV_DIR"

      - name: Install SDK tooling in venv
        if: steps.secret_check.outputs.run_smoke == 'true'
        run: |
          source "$VENV_DIR/bin/activate"
          python -m pip install --upgrade pip
          pip install -r "Management Pack/requirements.txt"

      - name: Backup repository connection files
        if: steps.secret_check.outputs.run_smoke == 'true'
        shell: bash
        run: |
          cp "Management Pack/connections.json" /tmp/connections.json.bak || true

      - name: Create CI SDK connection profile
        if: steps.secret_check.outputs.run_smoke == 'true'
        shell: bash
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          connections = {
            "suite_api_hostname": os.environ["VCF_OPS_HOST"],
            "suite_api_username": os.environ["VCF_OPS_USERNAME"],
            "suite_api_password": os.environ["VCF_OPS_PASSWORD"],
            "connections": [
              {
                "name": "ci",
                "identifiers": {
                  "host": os.environ["VCENTER_HOST"],
                  "port": os.environ["VCENTER_PORT"]
                },
                "credential": {
                  "user": os.environ["VCENTER_USERNAME"],
                  "password": os.environ["VCENTER_PASSWORD"]
                }
              }
            ]
          }

          Path("Management Pack/connections.json").write_text(json.dumps(connections, indent=2))
          PY

      - name: Run SDK connect smoke test
        if: steps.secret_check.outputs.run_smoke == 'true'
        run: |
          source "$VENV_DIR/bin/activate"
          mp-test -p "Management Pack" -c ci connect

      - name: Run SDK collect smoke test
        if: steps.secret_check.outputs.run_smoke == 'true'
        run: |
          source "$VENV_DIR/bin/activate"
          mp-test -p "Management Pack" -c ci collect -n 1 -w 5m

      - name: Restore repository connection files
        if: always() && steps.secret_check.outputs.run_smoke == 'true'
        run: |
          if [ -f /tmp/connections.json.bak ]; then
            mv /tmp/connections.json.bak "Management Pack/connections.json"
          else
            rm -f "Management Pack/connections.json"
          fi

      - name: Cleanup virtual environment
        if: always() && steps.secret_check.outputs.run_smoke == 'true'
        run: rm -rf "$VENV_DIR"
